<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моят профил</title>
    <link rel="icon" type="image/png" href="images/logo-removebg-preview.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .success-message {
            color: green;
        }

        .error-message {
            color: red;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/home">RecycleRewards</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <th:block th:if="${loggedUser != null}">
            <div th:replace="~{fragments/navbar-logged-in}"></div>
        </th:block>
        <th:block th:unless="${loggedUser != null}">
            <div th:replace="~{fragments/navbar-logged-out}"></div>
        </th:block>
    </div>
</nav>


<div class="container mt-5">
    <div class="jumbotron">
        <h1 class="display-4">Профилът на
            <span th:if="${loggedUser != null && loggedUser.getFirstName() != null}"
                  th:text="${loggedUser.getFirstName()}"></span>
            <span th:if="${loggedUser != null && loggedUser.getLastName() != null}"
                  th:text="${loggedUser.getLastName()}"></span>
        </h1>
        <hr class="my-4">
        <form action="/myProfile" method="post" id="profileForm">
            <input type="hidden" name="_method" value="patch"> <!-- This line overrides the (method with PATCH -->
            <div class="form-group">
                <label for="firstName">Първо име:</label>
                <input type="text" class="form-control" id="firstName" name="firstName" required
                       th:value="${loggedUser != null && loggedUser.getFirstName() != null ? loggedUser.getFirstName() : ''}">
            </div>
            <div class="form-group">
                <label for="lastName">Фамилия:</label>
                <input type="text" class="form-control" id="lastName" name="lastName" required
                       th:value="${loggedUser != null && loggedUser.getLastName() != null ? loggedUser.getLastName() : ''}">
            </div>
            <div class="form-group">
                <label for="email">Електронна поща:</label>
                <input type="email" class="form-control" id="email" name="email" required
                       th:value="${loggedUser != null && loggedUser.getEmail() != null ? loggedUser.getEmail()  : ''}">
            </div>
            <div class="form-group">
                <label for="email">Телефонен номер:</label>
                <input type="text" class="form-control" id="telephoneNumber" name="telephoneNumber"
                       th:value="${loggedUser != null && loggedUser.getPhone() != null ? loggedUser.getPhone()  : ''}">
            </div>
            <button type="submit" class="btn btn-primary">Актуализиране на данните</button>
            <div id="messageArea"></div>
        </form>
    </div>
</div>

<div th:replace="~{fragments/footer}"></div>

<script>
    // Function to display success or error message
    function showMessage(message, isError) {
        const messageArea = document.getElementById('messageArea');
        messageArea.innerText = message;
        messageArea.className = isError ? 'error-message' : 'success-message';
    }

    // Submit form using AJAX to handle response dynamically
    document.getElementById('profileForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent default form submission

        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: form.method,
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    return response.text(); // Return response body if successful
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                showMessage(data, false); // Display success message
            })
            .catch(error => {
                showMessage(error.message, true); // Display error message
            });
    });
</script>
</body>
</html>