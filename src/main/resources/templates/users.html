<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Потребители</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{fragments/navbar}"></div>

<div class="container mt-5">
    <div class="jumbotron">
        <h1 class="display-4">Потребители</h1>
        <hr class="my-4">
        <br>
        <div style="overflow-x:auto; overflow-y:auto; max-height: 400px;">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Име</th>
                    <th scope="col">Фамилия</th>
                    <th scope="col">Имейл</th>
                    <th scope="col">Телефон</th>
                    <th scope="col">Дата на регистрация</th>
                    <th scope="col">Точки</th>
                    <th scope="col">Роля</th>
                    <th scope="col">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user, rowStat : ${users}">
                    <td><span th:text="${user.id}"></span></td>
                    <td><span class="editable" contenteditable="true" th:text="${user.firstName}"></span></td>
                    <td><span class="editable" contenteditable="true" th:text="${user.lastName}"></span></td>
                    <td><span class="editable" contenteditable="true" th:text="${user.email}"></span></td>
                    <td><span class="editable" contenteditable="true" th:text="${user.phone}"></span></td>
                    <td th:text="${user.registrationDate}"></td>
                    <td th:text="${user.totalPoints}"></td>
                    <td class="editable" contenteditable="true" th:text="${user.role}"></td>
                    <td>
                        <button class="btn btn-primary btn-sm edit-btn">Edit</button>
                        <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                        <button class="btn btn-success btn-sm save-btn" style="display: none;">Save</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <a class="btn btn-primary btn-lg" href="#" role="button">Бутон</a>
    </div>
</div>

<div th:replace="~{fragments/footer}"></div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        // Event handler for sorting by column
        var sortOrders = {}; // Object to track sorting orders for each column

        $('th').on('click', function () {
            var columnIndex = $(this).index(); // Get the index of the clicked column

            // Toggle sorting order or set to ascending if not already set
            sortOrders[columnIndex] = (sortOrders[columnIndex] === 'asc') ? 'desc' : 'asc';

            // Get the table body
            var $tbody = $('table tbody');

            // Sort the rows based on the clicked column
            var rows = $tbody.find('tr').toArray();
            rows.sort(function (a, b) {
                var valueA = $(a).find('td:eq(' + columnIndex + ') span').text(); // Get the value of the cell
                var valueB = $(b).find('td:eq(' + columnIndex + ') span').text(); // Get the value of the cell

                // Custom parsing for specific columns
                if (columnIndex === 5) { // Date column (index 5)
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                } else if (columnIndex === 6) { // Points column (index 6)
                    valueA = parseFloat(valueA.replace(/,/g, '')); // Remove comma and parse as float
                    valueB = parseFloat(valueB.replace(/,/g, '')); // Remove comma and parse as float
                }

                if (sortOrders[columnIndex] === 'asc') {
                    return (valueA < valueB) ? -1 : (valueA > valueB) ? 1 : 0;
                } else {
                    return (valueA > valueB) ? -1 : (valueA < valueB) ? 1 : 0;
                }
            });

            // Reorder the rows in the table
            $.each(rows, function (index, row) {
                $tbody.append(row);
            });
        });


        // Event handler for Edit button
        $(document).on('click', '.edit-btn', function () {
            // Find the closest row
            var $row = $(this).closest('tr');

            // Enable editing for all cells
            $row.find('.editable').prop('contenteditable', true);

            // Change background color of the row to yellow
            $row.css('background-color', 'yellow');

            // Hide the Delete button and show the Save button
            $row.find('.delete-btn').hide();
            $row.find('.save-btn').show();
            $(this).hide();
        });

        // Event handler for Save button
        $(document).on('click', '.save-btn', function () {
            // Find the closest row
            var $row = $(this).closest('tr');

            // Disable editing for all cells
            $row.find('.editable').prop('contenteditable', false);

            // Revert background color of the row to white
            $row.css('background-color', 'white');

            // Show the Delete button and Edit button, hide the Save button
            $row.find('.delete-btn').show();
            $row.find('.edit-btn').show();
            $(this).hide();

            // Extract updated data from the row
            var userId = $row.find('td:eq(0) span').text();
            var firstName = $row.find('td:eq(1) span').text();
            var lastName = $row.find('td:eq(2) span').text();
            var email = $row.find('td:eq(3) span').text();
            var phone = $row.find('td:eq(4) span').text();

// Send AJAX request to update user data
            $.ajax({
                url: '/update/' + userId,
                type: 'PATCH',
                contentType: 'application/json', // Set content type to JSON
                data: JSON.stringify({
                    id: userId,
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone
                }),
                success: function (response) {
                    // Handle success response
                    console.log('User updated successfully');
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    console.error('Error updating user');
                }
            });

        });

        // Event handler for Delete button
        $(document).on('click', '.delete-btn', function () {
            // Find the closest row
            var $row = $(this).closest('tr');

            // Extract user ID from the Edit button in the same row
            var userId = $row.find('td:eq(0) span').text();

            // Send AJAX request to delete user
            $.ajax({
                url: '/delete/' + userId,
                type: 'GET', // Change the request type to GET
                success: function (response) {
                    // Handle success response, maybe show a message or refresh the page
                    console.log('User deleted successfully');
                    window.location.reload(); // Refresh the page
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    console.error('Error deleting user');
                }
            });
        });
    });
</script>

</body>
</html>